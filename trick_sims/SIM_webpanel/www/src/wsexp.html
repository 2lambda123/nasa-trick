<!DOCTYPE html>
<html>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/CSS" href="wsexp.css">
    <title>WS Experiments</title>
<!--START OF GRID LAYOUT -->
<body>
    <div id="parent"> 
        <nav id="navchild" style="font-size: small">
            <button onclick="file()" style="float: right; border: 1px solid black;"><u>F</u>ile</button>
            <button onclick="actions()" style="float: right; border: 1px solid black;"><u>A</u>ctions</button>
        </nav>
        <header id="headerchild">
            <img src="../images/trick.png" style="float: left; width: 15%">
            <h1>Sim Control</h1>
            <hr>
        </header> 
        <div id="tablechild"> 
            
            <table class="variables" style="width: 100%;">
                <div>
                <h2 style="width: 100%; text-align: center;">Simulation Variable Table</h2>
                    <tr>
                        <th class="table">Variable</th>
                        <th class="table">Value</th>
                    </tr> 
                </div>
            </table>
        </div>
        <div id="modechild">
        <table style="width: 100%;">
            <tr>
                <th style="background-color: rgb(103, 161, 243)">MODE</th>
                <tr>
                    <td>PERCENTAGE</td>
                </tr>
                
            </tr>
        </table>
        </div>
        <div id="buttonchild" >
            <table class="commands"style="width: 100%; height: 100%;">
       
                <th id="command" colspan="2" >Commands</th>
                
                <tr>
                    <td><button onclick="stepSIM(value)" class="cmdbtn" id="step" >Step</button> </td>
                    <td><button onclick="recordSIM()" class="cmdbtn" id="data" checked="checked">Data Rec On</button></td>
                </tr>
           
                <tr>
                    <td><button onclick="startSIM()" class="cmdbtn" id="start">Start</button></td>
                    <td><button onclick="realtimeSim()" class="cmdbtn" id="realtime">RealTime On</button></td>
                </tr>
                <tr>
                   <td><button onclick="freezeSIM()" class="cmdbtn" id="freeze">Freeze</button></td> 
                   <td><button onclick="dumpChkpnt()" class="cmdbtn" id="dump">Dump Chkpnt</button></td>
                </tr>
                <tr>
                    <td><button onclick="shutdownSIM()" class="cmdbtn" id="shutdown">Shutdown</button></td> 
                    <td><button onclick="loadChkpnt()" class="cmdbtn" id="load">Load Chkpnt</button></td> 
                </tr>
                <tr>
                    <td><button onclick="getAllButtons()">Buttons</button></td> 
                    <td colspan="2"><button onclick="window.close()" class="cmdbtn" id="exit">E<u>x</u>it</button></td> 
                    <td><button onclick="setTime(value)">EXP</button></td> 
                </tr>
           
            </table>
        </div>
        <div id="barchild">
            Here is a place for the buttons that start Trick TV, MTV, and Throttle.
            <hr>
        </div>
        <div id="bottomchild">
            <table style="width: 100vw;"> 
                <tr> 
                    <th style="background-color: rgb(103, 161, 243)">Simulations/Overruns</th>
                </tr>
                <tr>
                    <td>This is where the path goes</td>
                </tr>
            </table>
        </div>
        <div id="extrabottomchild"> 
            <table style="width: 100vw;"> 
                <tr> 
                    <th style="background-color: rgb(103, 161, 243)">Status Messages</th>
                </tr>
                <tr>
                    <td>Space for the status messages</td>
                </tr>
            </table>
        </div>
        <div id="timechild">
            <table style="height: 85%">
                <tr>
                    <th style="background-color: rgb(103, 161, 243)" >Time</th>
                </tr>
                <tr>
                    <th>RET (sec)</th>
                </tr>
                <tr>
                    <td id="RET" script="setTime()">0</td>
                </tr>
                <tr>
                    <th>Sim / Real Time</th>
                </tr>
                    <td>1</td>
            </table>
        </div>
    </div>

    <div id="output">
        <script type="text/javascript">
           // Sets the data rec and real time on by default 
            document.getElementById("data").checked = true;
            document.getElementById("realtime").checked = true;
            var dir;
            var tiempo;
        
           

            function log(s) {
                var p = document.createElement("p");
                p.style.wordWrap = "break-word";
                p.textContent = s;
                output.appendChild(p);
            }
            function sendMessage(msg) {
                ws.send(msg);
                //log("Sent : " + msg);
            }
            // Interface to Trick WebSocket Variable Server
            function setPeriod(period) {
                sendMessage(`{"cmd":"var_cycle","period":${period}}`);
            }
            function addVarTableRow(name, value) {
                // create a row in the table that contains two <td>s, one for the var_name and one for its value.
                let tr = document.createElement('tr');  
                let td1 = document.createElement('td');
                td1.textContent = `${name}`;
                let td2 = document.createElement('td');
                td2.textContent = `${value}`;
                td2.className = "values";
                tr.appendChild(td1);
                tr.appendChild(td2);
                varTable.appendChild(tr);
            }
            function addVariable(name, value) {
                sendMessage(`{"cmd":"var_add","var_name": "${name}"}`);
                addVarTableRow(name, value);
            }
            // Functions for buttons 
            function shutdownSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.stop()"}`);
            }
            function startSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.exec_run()"}`);
            }
            function freezeSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.exec_freeze()"}`);
                sendMessage(`{"cmd": "python", "pycode": "trick.debug_pause_off()"}`);
            }
            function recordSIM(){
                var databtn = document.getElementById("data");
                if (databtn.checked == false){
                    databtn.innerText = "Data Rec On";
                    sendMessage(`{"cmd": "python", "pycode": "trick.dr_enable()"}`);
                    databtn.checked = true;
                } else {
                    databtn.innerText = "Data Rec Off";
                    sendMessage(`{"cmd": "python", "pycode": "trick.dr_disable()"}`);
                    databtn.checked = false;
                }
            }
            function realtimeSim(){
                var rtbtn = document.getElementById("realtime");
              
              
              if (rtbtn.checked == false){
                  rtbtn.innerText = "RealTime On";
                  sendMessage(`{"cmd": "python", "pycode": "trick.real_time_enable()"}`);
                  rtbtn.checked = true;
              } else {
                  rtbtn.innerText = "RealTime Off";
                  sendMessage(`{"cmd": "python", "pycode": "trick.real_time_disable()"}`);
                  rtbtn.checked = false;
              }
            }
            function stepSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.debug_pause_on()"}`);
                sendMessage(`{"cmd": "python", "pycode": "trick.exec_run()"}`);
                sendMessage(`{"cmd": "python", "pycode": "trick.debug_signal()"}`);
            }
            function setTime(t){
                tiempo = t.toFixed(2);
                //tiempo.toFixed(2);
                document.getElementById("RET").textContent = tiempo;
            }
            function setDir (r,d){
                dir = d + "/" + r;
            }
            
            
            // MY EXPERIMENTS
            function loadChkpnt (){
              var file = "chkpnt_" + tiempo;
    
              sendMessage(`{"cmd": "python", "pycode": "trick.load_checkpoint('${dir}' + '/' + '${file}')"}`);
            }
            function dumpChkpnt (){
                var file = "chkpnt_" + tiempo;
                
                sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint('${file}')"}`);
               
               /* Unable to do send last command due to no checkpoint objects 
               
               sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint_objects('${file}' + ',' + '${checkpointObjects}')"}`);
                 if (file != null){
                    
                        if (checkpointObjects == null || "".equals(checkpointObjects)){
                            sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint('${file}')"}`);
                        } else {
                            sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint_objects('${file}' + ',' + '${checkpointObjects}')"}`);
                        }
                } */
            }
            // Working on enable/disable buttons
            function enableAllButtons(commandStr, flag){
                if (commandStr != null){
                    const commands = commandStr.split(", ");
                    setCommandsEnabled(acts, flag);
                }
            }
            function disableAllButtons(commands, flag){
                const button = document.querySelectorAll('button');
               // button.disabled = true; 
            }
            function getAllButtons (){
                const commands = ["step", "start", "freeze", "shutdown", "data", "realtime",
                "dump", "load"];
                for (let x = 0; x < commands.length; x++){
                    document.getElementById(commands[x]);
                    const button = document.querySelector(commands[x]);
                    button.disabled = true;
                    console.log(commands[x]);
                }

            }

            // END OF EXPERIMENT 
            var varTable = document.querySelector('table.variables');
            var ws = new WebSocket('ws://localhost:8888/api/ws/VariableServer');
             
            // WebSocket Event Handlers
            ws.onopen = function(e) {
                log("Connection established");
                setPeriod(100);
                addVarTableRow("Time", 0.0);
                addVariable("trick_sys.sched.mode", 0);
                addVariable("trick_sys.name", 'trick_sys');
                addVariable("dyn.balloon.pos[0]", 0.0);
                addVariable("dyn.balloon.pos[1]", 0.0);
                addVariable("dyn.balloon.vel[0]", 0.0);
                addVariable("dyn.balloon.vel[1]", 0.0);
                addVariable("dyn.balloon.envelope_air_temperature", 92.0);
                addVariable("dyn.balloon.wind_speed", 0.0);
                addVariable("trick_cmd_args.cmd_args.run_dir"); 
                addVariable("trick_cmd_args.cmd_args.default_dir");
                sendMessage('{\"cmd\":\"var_unpause\"}');
               // addVariable("trick_instruments.debug_pause.debug_pause_flag", 0);
                
            };
            ws.onmessage = function(e) {
              //  log("Recieved : " + e.data);
               let msg = JSON.parse(e.data);
               if (msg.msg_type == "values") {
                   let valueNodes = varTable.getElementsByClassName("values");
                   valueNodes[0].textContent = msg.time;
                   setTime(msg.time);
                   for (let i = 0; i < msg.values.length; i++ ) {
                       valueNodes[i+1].textContent = msg.values[i];
                   }
                   let runDir = valueNodes[9].textContent;
                   let defDir = valueNodes[10].textContent;
                   setDir(runDir, defDir);
                   
                
               }
              
            }; 	
            ws.onerror = function(e) {
               console.log("WebSocket Error: " , e);
              // handleErrors(e);
            };
            ws.onclose = function(e) {
               console.log("Connection closed", e);
               window.close();
            };
  
        </script>
    </div>
</body>
</html>